name: Build and release

on:
  push:
    branches: [ "main" ]
    tags: [ "*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582

    - name: Build with Gradle Wrapper
      run: ./gradlew build

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: mod
        path: build/libs/*.jar

    - name: Detect release type
      if: startsWith(github.ref, 'refs/tags/')
      id: release_type
      run: |
        tag="${GITHUB_REF#refs/tags/}"
        if [[ "$tag" == *alpha* ]]; then
          echo "type=alpha" >> $GITHUB_OUTPUT
        elif [[ "$tag" == *beta* ]]; then
          echo "type=beta" >> $GITHUB_OUTPUT
        else
          echo "type=release" >> $GITHUB_OUTPUT
          fi

    - name: Publish to GitHub + Modrinth
      if: startsWith(github.ref, 'refs/tags/')
      uses: Kira-NT/mc-publish@v3.3.0
      with:
        modrinth-id: betterthanmodern
        modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

        github-token: ${{ secrets.GITHUB_TOKEN }}
        github-generate-release-notes: true

        version: ${{ github.ref_name }}
        version-type: ${{ steps.release_type.outputs.type }}
        loaders: fabric, babric
        game-versions: "b1.7.3"
